# name: Deploy Application
#
# on:
#   workflow_dispatch:
#     inputs:
#       environment:
#         description: 'Environment to deploy'
#         required: true
#         type: choice
#         options:
#           - development
#           - staging
#           - production
#       version:
#         description: 'Version/tag to deploy (default: latest)'
#         required: false
#         default: 'latest'
#
#   push:
#     branches:
#       - develop
#       - staging
#       - master
#
# jobs:
#   determine-environment:
#     name: Determine Deployment Environment
#     runs-on: ubuntu-latest
#     outputs:
#       environment: ${{ steps.set-env.outputs.environment }}
#       should-deploy: ${{ steps.set-env.outputs.should-deploy }}
#
#     steps:
#       - name: Set environment
#         id: set-env
#         run: |
#           if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
#             echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
#             echo "should-deploy=true" >> $GITHUB_OUTPUT
#           elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
#             echo "environment=development" >> $GITHUB_OUTPUT
#             echo "should-deploy=true" >> $GITHUB_OUTPUT
#           elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
#             echo "environment=staging" >> $GITHUB_OUTPUT
#             echo "should-deploy=true" >> $GITHUB_OUTPUT
#           elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
#             echo "environment=production" >> $GITHUB_OUTPUT
#             echo "should-deploy=false" >> $GITHUB_OUTPUT
#           else
#             echo "should-deploy=false" >> $GITHUB_OUTPUT
#           fi
#
#   deploy:
#     name: Deploy to ${{ needs.determine-environment.outputs.environment }}
#     runs-on: ubuntu-latest
#     needs: determine-environment
#     if: needs.determine-environment.outputs.should-deploy == 'true'
#     environment:
#       name: ${{ needs.determine-environment.outputs.environment }}
#       url: ${{ steps.deploy.outputs.url }}
#
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#
#       - name: Set deployment variables
#         id: vars
#         run: |
#           ENV="${{ needs.determine-environment.outputs.environment }}"
#           VERSION="${{ inputs.version || 'latest' }}"
#
#           echo "version=$VERSION" >> $GITHUB_OUTPUT
#
#           if [[ "$ENV" == "production" ]]; then
#             echo "url=https://travelnest.com" >> $GITHUB_OUTPUT
#             echo "namespace=production" >> $GITHUB_OUTPUT
#           elif [[ "$ENV" == "staging" ]]; then
#             echo "url=https://staging.travelnest.com" >> $GITHUB_OUTPUT
#             echo "namespace=staging" >> $GITHUB_OUTPUT
#           else
#             echo "url=https://dev.travelnest.com" >> $GITHUB_OUTPUT
#             echo "namespace=development" >> $GITHUB_OUTPUT
#           fi
#
#       - name: Deploy via SSH (Docker Compose)
#         id: deploy
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.DEPLOY_HOST }}
#           username: ${{ secrets.DEPLOY_USER }}
#           key: ${{ secrets.DEPLOY_SSH_KEY }}
#           port: ${{ secrets.DEPLOY_PORT || 22 }}
#           script: |
#             cd /opt/travelnest
#
#             # Pull latest images
#             docker pull ${{ secrets.DOCKERHUB_USERNAME }}/travelnest-backend:${{ steps.vars.outputs.version }}
#             docker pull ${{ secrets.DOCKERHUB_USERNAME }}/travelnest-frontend:${{ steps.vars.outputs.version }}
#
#             # Update docker-compose.yml with new image tags
#             export BACKEND_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/travelnest-backend:${{ steps.vars.outputs.version }}
#             export FRONTEND_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/travelnest-frontend:${{ steps.vars.outputs.version }}
#
#             # Run database migrations
#             docker-compose run --rm server npm run migrate
#
#             # Deploy with zero downtime (rolling update)
#             docker-compose up -d --no-deps --build server
#             docker-compose up -d --no-deps --build client
#
#             # Wait for health checks
#             sleep 10
#
#             # Verify deployment
#             docker-compose ps
#
#             # Clean up old images
#             docker image prune -f
#
#       - name: Run smoke tests
#         run: |
#           sleep 15
#
#           # Test backend health
#           curl -f ${{ steps.vars.outputs.url }}/api/health || exit 1
#
#           # Test frontend
#           curl -f ${{ steps.vars.outputs.url }} || exit 1
#
#           echo "✅ Smoke tests passed"
#
#       - name: Rollback on failure
#         if: failure()
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.DEPLOY_HOST }}
#           username: ${{ secrets.DEPLOY_USER }}
#           key: ${{ secrets.DEPLOY_SSH_KEY }}
#           port: ${{ secrets.DEPLOY_PORT || 22 }}
#           script: |
#             cd /opt/travelnest
#
#             # Rollback to previous version
#             docker-compose down
#             git checkout HEAD~1
#             docker-compose up -d
#
#             echo "⚠️ Deployment rolled back"
#
#       - name: Send deployment notification
#         if: always()
#         uses: slackapi/slack-github-action@v1
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#         with:
#           payload: |
#             {
#               "text": "Deployment ${{ job.status }}",
#               "blocks": [
#                 {
#                   "type": "section",
#                   "text": {
#                     "type": "mrkdwn",
#                     "text": "${{ job.status == 'success' && '✅' || '❌' }} Deployment to *${{ needs.determine-environment.outputs.environment }}* ${{ job.status }}\n*Version:* ${{ steps.vars.outputs.version }}\n*URL:* ${{ steps.vars.outputs.url }}\n*Actor:* ${{ github.actor }}"
#                   }
#                 }
#               ]
#             }
#
#   deploy-production:
#     name: Deploy to Production (Manual Approval)
#     runs-on: ubuntu-latest
#     needs: determine-environment
#     if: github.ref == 'refs/heads/master'
#     environment:
#       name: production
#       url: https://travelnest.com
#
#     steps:
#       - name: Manual approval required
#         run: |
#           echo "⏳ Waiting for manual approval to deploy to production..."
#           echo "This job requires manual approval in GitHub Actions UI"
#
#       - name: Checkout code
#         uses: actions/checkout@v4
#
#       - name: Deploy to production
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.PROD_DEPLOY_HOST }}
#           username: ${{ secrets.PROD_DEPLOY_USER }}
#           key: ${{ secrets.PROD_DEPLOY_SSH_KEY }}
#           port: ${{ secrets.PROD_DEPLOY_PORT || 22 }}
#           script: |
#             cd /opt/travelnest-prod
#
#             # Create backup
#             docker-compose exec -T mysql mysqldump -u root -p$MYSQL_ROOT_PASSWORD booking_website > backup_$(date +%Y%m%d_%H%M%S).sql
#
#             # Pull latest images
#             docker pull ${{ secrets.DOCKERHUB_USERNAME }}/travelnest-backend:latest
#             docker pull ${{ secrets.DOCKERHUB_USERNAME }}/travelnest-frontend:latest
#
#             # Run migrations
#             docker-compose run --rm server npm run migrate
#
#             # Blue-green deployment
#             docker-compose up -d --scale server=2 --no-recreate
#             sleep 10
#             docker-compose up -d --scale server=1 --no-recreate
#
#             # Verify
#             docker-compose ps
#
#             echo "✅ Production deployment completed"
#
#       - name: Create deployment record
#         uses: actions/github-script@v7
#         with:
#           script: |
#             await github.rest.repos.createDeployment({
#               owner: context.repo.owner,
#               repo: context.repo.repo,
#               ref: context.sha,
#               environment: 'production',
#               description: 'Production deployment',
#               auto_merge: false
#             });
